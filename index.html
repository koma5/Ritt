<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>still to be named</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            padding: 0;
            margin: 0;
            font-family: sans-serif;
            color: white;
            font-weight: bold;
        }

        html, body, #map{
            height: 100%;
            width: 100%;
            display: flex;
        }

        #map {
            flex-direction:columns;
        }

        #sidebar {
            background-color: #8b6c74;
            width: 300px;
            height:100%;
            transition: width 0.3s ease-in-out;
            box-shadow: inset -56px 0px 52px -59px rgba(0,0,0,0.75);
            padding: 5 0 0 5px;
        }

        #burger {
            position: relative;
            top: 80px;
            background-color: #fff;
            left: 10px;
            z-index: 10000;
            width: 34px;
            height: 34px;
            padding: 0;
            border-radius: 4px;
            border:none;
            line-height:22px;
            font-size:1.9em;
            border: 2px solid rgba(0,0,0,.3);
        }


    </style>

</head>
<body>
    <section id="sidebar">
        <label for="follow">follow</label>
        <input id="follow" checked type="checkbox" value="follow" onclick="toggleFollow()" >
        <p>positions: <span id="positionCount"></span><br>
        last update: <span id="relativeTimestamp"></span</p>
    </section>
    <section id="map">
        <button id="burger" onclick="toggleSidebar()"><</button>
    </section>

    <script>
    var initPosition = [51.528858, -0.220988];
    var follow = true;

    var positionCount = 0;
    var lastPositionTimestamp = null;

    var map = L.map('map').setView(initPosition, 16);
	var Stamen_Watercolor = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.{ext}', {
		attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
		subdomains: 'abcd',
		minZoom: 1,
		maxZoom: 16,
		ext: 'jpg'
	}).addTo(map);


    var client = mqtt.connect('wss://iot.eclipse.org:443/ws')

    client.subscribe("t.blahhhhh.ga/latlong")

    var cyclistIcon = L.icon({
        iconUrl: 'bicyclist_1f6b4.png',
        iconSize: [35, 35],
        iconAnchor: [8, 34],
        shadowUrl: 'bicyclist_1f6b4_shadow.png',
        shadowSize: [35, 35],
        shadowAnchor: [8, 34]
    })

    var marker = L.marker(initPosition, {icon: cyclistIcon}
    ).addTo(map);

	var trackLine = new L.Polyline([], {
		color: '#4287f5',
		weight: 3,
		opacity: 0.5,
		smoothFactor: 2
	 });

	map.addLayer(trackLine);

    client.on("message", function (topic, payload) {
        var [lat, lng] = payload.toString().split(',');
        console.log(lat, lng);
        marker.setLatLng(new L.LatLng(lat, lng));

		if (positionCount > 500)
		{
			trackLine._latlngs.shift();
		}

		trackLine.addLatLng([lat, lng]);

        lastPositionTimestamp = new Date();
        positionCount++;
        if(follow) { map.setView([lat, lng]);};
    })

    function toggleFollow() {
        follow = !follow;
    }

    function toggleSidebar() {
        element = document.getElementById('sidebar');
        if (element.style.length == 0) {
            element.style = "width:0";
        }
        else {
            element.style = '';
        }
        map.invalidateSize(); //this does not work with transitio
    }

    setInterval(function() {
        timeDelta = parseInt((new Date().getTime() - lastPositionTimestamp.getTime()) / 1000);
        if (timeDelta < 60)
            deltaString = parseInt(timeDelta) + 's ago'
        else {
            timeDelta / 60;
            deltaString = parseInt(timeDelta / 60) + 'm ago';
        }
        document.getElementById('relativeTimestamp').innerHTML = deltaString;
        document.getElementById('positionCount').innerHTML = positionCount;
    }, 1000);

    </script>

</body>
</html>

